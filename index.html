<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pong FX</title>
  <style>
    body { margin: 0; background: black; }
    canvas { display: block; margin: auto; background: #111; border: 2px solid white; }
  </style>
</head>
<body>
<canvas id="gameCanvas" width="640" height="480"></canvas>
<script>
// === SETUP ===
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

let keys = {};
document.addEventListener("keydown", e => keys[e.key] = true);
document.addEventListener("keyup", e => keys[e.key] = false);

// === SOUND EFFECT ===
const bounceSound = new AudioContext();
let bounceBuffer;

fetch("https://freesound.org/data/previews/337/337049_3232290-lq.mp3") // tiny pong sound
  .then(res => res.arrayBuffer())
  .then(data => bounceSound.decodeAudioData(data))
  .then(buffer => bounceBuffer = buffer);

// === PARTICLE SYSTEM ===
let particles = [];
function spawnParticles(x, y) {
  for (let i = 0; i < 10; i++) {
    particles.push({ x, y, dx: Math.random()*4-2, dy: Math.random()*4-2, life: 30 });
  }
}

// === GAME STATE ===
let ball = { x: 320, y: 240, dx: 3, dy: 2 };
let leftPaddle = { y: 200 };
let rightPaddle = { y: 200 };
const paddleHeight = 80;

// === DRAW FUNCTIONS ===
function drawRect(x, y, w, h, color="white") {
  ctx.fillStyle = color;
  ctx.fillRect(x, y, w, h);
}

function drawBall() {
  drawRect(ball.x - 5, ball.y - 5, 10, 10);
}

function drawParticles() {
  for (let p of particles) {
    drawRect(p.x, p.y, 2, 2, "yellow");
  }
}

// === UPDATE ===
function update() {
  // Move paddles
  if (keys["w"]) leftPaddle.y -= 5;
  if (keys["s"]) leftPaddle.y += 5;
  if (keys["ArrowUp"]) rightPaddle.y -= 5;
  if (keys["ArrowDown"]) rightPaddle.y += 5;

  // Clamp paddles
  leftPaddle.y = Math.max(0, Math.min(400, leftPaddle.y));
  rightPaddle.y = Math.max(0, Math.min(400, rightPaddle.y));

  // Move ball
  ball.x += ball.dx;
  ball.y += ball.dy;

  // Bounce top/bottom
  if (ball.y <= 0 || ball.y >= 470) ball.dy *= -1;

  // Bounce paddles
  if (ball.x < 30 && ball.y > leftPaddle.y && ball.y < leftPaddle.y + paddleHeight) {
    ball.dx *= -1;
    playBounce();
    spawnParticles(ball.x, ball.y);
  }
  if (ball.x > 610 && ball.y > rightPaddle.y && ball.y < rightPaddle.y + paddleHeight) {
    ball.dx *= -1;
    playBounce();
    spawnParticles(ball.x, ball.y);
  }

  // Reset if out of bounds
  if (ball.x < 0 || ball.x > 640) {
    ball.x = 320;
    ball.y = 240;
    ball.dx = 3 * (Math.random() > 0.5 ? 1 : -1);
    ball.dy = 2 * (Math.random() > 0.5 ? 1 : -1);
  }

  // Update particles
  particles = particles.filter(p => p.life-- > 0);
  for (let p of particles) {
    p.x += p.dx;
    p.y += p.dy;
  }
}

// === SOUND TRIGGER ===
function playBounce() {
  if (!bounceBuffer) return;
  const src = bounceSound.createBufferSource();
  src.buffer = bounceBuffer;
  src.connect(bounceSound.destination);
  src.start();
}

// === MAIN LOOP ===
function loop() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  update();
  drawRect(10, leftPaddle.y, 10, paddleHeight);
  drawRect(620, rightPaddle.y, 10, paddleHeight);
  drawBall();
  drawParticles();
  requestAnimationFrame(loop);
}

loop();
</script>
</body>
</html>
